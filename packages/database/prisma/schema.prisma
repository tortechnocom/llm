// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector, uuid_ossp(map: "uuid-ossp"), pg_trgm]
}

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String   @unique
  password  String
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  agents            Agent[]
  tokenTransactions TokenTransaction[]

  @@map("users")
}

model Agent {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  trainerId             String   @map("trainer_id") @db.Uuid
  name                  String   @db.VarChar(255)
  domain                String?  @db.VarChar(50)
  systemPrompt          String?  @map("system_prompt") @db.Text
  tokenPriceMultiplier  Float    @default(1.0) @map("token_price_multiplier")
  isPublic              Boolean  @default(false) @map("is_public")
  description           String?  @db.Text
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  trainer           User               @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  knowledgeBase     KnowledgeBase[]
  tokenTransactions TokenTransaction[]

  @@index([trainerId])
  @@index([domain])
  @@index([isPublic])
  @@map("agents")
}

model KnowledgeBase {
  id        String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agentId   String                 @map("agent_id") @db.Uuid
  title     String?                @db.Text
  content   String                 @db.Text
  embedding Unsupported("vector(4096)")?
  metadata  Json?                  @db.JsonB
  tags      String[]
  createdAt DateTime               @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@map("knowledge_base")
}

enum TransactionType {
  USAGE
  TOPUP
  WITHDRAWAL
  REWARD

  @@map("transaction_type")
}

model TokenTransaction {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String          @map("user_id") @db.Uuid
  agentId         String?         @map("agent_id") @db.Uuid
  tokensUsed      Int             @map("tokens_used")
  amountDeducted  Decimal         @map("amount_deducted") @db.Decimal(10, 4)
  transactionType TransactionType @map("transaction_type")

  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent Agent? @relation(fields: [agentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([agentId])
  @@index([transactionType])
  @@index([createdAt])
  @@map("token_transactions")
}

model ChatSession {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  agentId   String   @map("agent_id") @db.Uuid
  title     String?  @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  messages ChatMessage[]

  @@index([userId])
  @@index([agentId])
  @@map("chat_sessions")
}

model ChatMessage {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId String   @map("session_id") @db.Uuid
  role      String   @db.VarChar(20) // 'user' or 'assistant'
  content   String   @db.Text
  metadata  Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("chat_messages")
}
